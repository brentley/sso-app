{% extends "base.html" %}

{% block title %}VisiQuate SSO Test App - Admin Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Admin Dashboard</h2>
            <div class="btn-group" role="group">
                <a href="{{ url_for('admin_config') }}" class="btn btn-primary">
                    <i class="fas fa-cogs me-2"></i>Configuration Settings
                </a>
                <a href="{{ url_for('admin_scim_logs') }}" class="btn btn-info">
                    <i class="fas fa-list-alt me-2"></i>SCIM Logs
                </a>
                {% if current_user.is_admin or current_user.is_auditor %}
                    <button onclick="reconcilePasskeys()" class="btn btn-warning" title="Reconcile passkey status for users who have completed SAML or OIDC testing">
                        <i class="fas fa-sync-alt me-2"></i>Reconcile Passkeys
                    </button>
                {% endif %}
                {% if current_user.is_super_admin %}
                    <a href="{{ url_for('admin_impersonate') }}" class="btn btn-warning">
                        <i class="fas fa-user-secret me-2"></i>User Impersonation
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4" id="metrics-summary">
            <div class="col-lg-2 col-md-3 mb-3">
                <div class="card metric-card" data-filter="all" style="cursor: pointer;">
                    <div class="card-body text-center">
                        <h6 class="card-title">Total Users</h6>
                        <h3 class="text-primary">{{ (active_users|length) + (inactive_users|length) }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-3 mb-3">
                <div class="card metric-card" data-filter="not-started" style="cursor: pointer;">
                    <div class="card-body text-center">
                        <h6 class="card-title">Not Started</h6>
                        <h3 class="text-warning">{{ inactive_users|length }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-3 mb-3">
                <div class="card metric-card" data-filter="saml" style="cursor: pointer;">
                    <div class="card-body text-center">
                        <h6 class="card-title">SAML Tested</h6>
                        <h3 class="text-success">{{ (active_users + inactive_users)|selectattr("saml_tested")|list|length }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-3 mb-3">
                <div class="card metric-card" data-filter="oidc" style="cursor: pointer;">
                    <div class="card-body text-center">
                        <h6 class="card-title">OIDC Tested</h6>
                        <h3 class="text-success">{{ (active_users + inactive_users)|selectattr("oidc_tested")|list|length }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-3 mb-3">
                <div class="card metric-card" data-filter="passkey" style="cursor: pointer;">
                    <div class="card-body text-center">
                        <h6 class="card-title">Passkey Tested</h6>
                        <h3 class="text-success">{{ (active_users + inactive_users)|selectattr("passkey_tested")|list|length }}</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-3 mb-3">
                <div class="card metric-card" data-filter="complete" style="cursor: pointer;">
                    <div class="card-body text-center">
                        <h6 class="card-title">All Complete</h6>
                        <h3 class="text-success">
                            {{ (active_users + inactive_users)|selectattr("saml_tested")|selectattr("oidc_tested")|selectattr("passkey_tested")|list|length }}
                        </h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Status and Clear Button -->
        <div class="row mb-3" id="filter-status" style="display: none;">
            <div class="col-12">
                <div class="alert alert-info d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-filter me-2"></i>Filtering users: <span id="filter-description"></span></span>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="clear-filter">
                        <i class="fas fa-times me-1"></i>Clear Filter
                    </button>
                </div>
            </div>
        </div>

        <!-- Active Users (>0% completion) -->
        {% if active_users %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Active Users ({{ active_users|length }} users with >0% completion)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>SCIM Provisioned</th>
                                <th>SAML</th>
                                <th>OIDC</th>
                                <th>Passkey</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in active_users %}
                            <tr class="{{ 'table-warning' if not user.active else '' }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div>
                                            <div class="fw-bold">{{ user.name }}</div>
                                            {% if user.is_admin %}
                                                <small class="badge bg-danger">Admin</small>
                                            {% elif user.is_auditor %}
                                                <small class="badge bg-info">Auditor</small>
                                            {% endif %}
                                            {% if not user.active %}
                                                <small class="badge bg-warning">Inactive</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <code>{{ user.email }}</code>
                                    {% if user.external_id %}
                                        <br><small class="text-muted">External ID: {{ user.external_id[:10] }}...</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge {{ 'bg-success' if user.scim_provisioned else 'bg-secondary' }}">
                                        {{ 'Yes' if user.scim_provisioned else 'No' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {{ 'bg-success' if user.saml_tested else 'bg-secondary' }}">
                                        {{ 'Tested' if user.saml_tested else 'Not Tested' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {{ 'bg-success' if user.oidc_tested else 'bg-secondary' }}">
                                        {{ 'Tested' if user.oidc_tested else 'Not Tested' }}
                                    </span>
                                </td>
                                <td>
                                    {% if user.passkey_tested %}
                                        <span class="badge bg-success">Tested</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Not Tested</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ user.created_at.strftime('%Y-%m-%d') }}</small>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="viewUserLogs({{ user.id }})">
                                        View Logs
                                    </button>
                                    {% if current_user.is_admin %}
                                        <button class="btn btn-sm btn-outline-warning me-1" onclick="clearTestStatus({{ user.id }}, '{{ user.email }}')">
                                            <i class="fas fa-undo me-1"></i>Clear Tests
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ user.id }}, '{{ user.email }}')">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Inactive Users (0% completion) - Collapsible -->
        {% if inactive_users %}
        <div class="card">
            <div class="card-header">
                <button class="btn btn-link text-decoration-none p-0 text-start w-100" type="button" data-bs-toggle="collapse" data-bs-target="#inactiveUsersCollapse" aria-expanded="false" aria-controls="inactiveUsersCollapse">
                    <h5 class="mb-0 d-flex justify-content-between align-items-center">
                        <span>Inactive Users ({{ inactive_users|length }} users with 0% completion)</span>
                        <i class="fas fa-chevron-down"></i>
                    </h5>
                </button>
            </div>
            <div class="collapse" id="inactiveUsersCollapse">
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        These users haven't completed any authentication tests yet (SAML, OIDC, or Passkey).
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>SCIM Provisioned</th>
                                    <th>SAML</th>
                                    <th>OIDC</th>
                                    <th>Passkey</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in inactive_users %}
                                <tr class="table-light {{ 'table-warning' if not user.active else '' }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div>
                                                <div class="fw-bold">{{ user.name }}</div>
                                                {% if user.is_admin %}
                                                    <small class="badge bg-danger">Admin</small>
                                                {% elif user.is_auditor %}
                                                    <small class="badge bg-info">Auditor</small>
                                                {% endif %}
                                                {% if not user.active %}
                                                    <small class="badge bg-warning">Inactive</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <code>{{ user.email }}</code>
                                        {% if user.external_id %}
                                            <br><small class="text-muted">External ID: {{ user.external_id[:10] }}...</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge {{ 'bg-success' if user.scim_provisioned else 'bg-secondary' }}">
                                            {{ 'Yes' if user.scim_provisioned else 'No' }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">Not Tested</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">Not Tested</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">Not Tested</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ user.created_at.strftime('%Y-%m-%d') }}</small>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewUserLogs({{ user.id }})">
                                            View Logs
                                        </button>
                                        {% if current_user.is_admin %}
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ user.id }}, '{{ user.email }}')">
                                                <i class="fas fa-trash me-1"></i>Delete
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>

<!-- User Logs Modal -->
<div class="modal fade" id="userLogsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Authentication Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="userLogsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// Auto-refresh metrics every 10 seconds
let metricsRefreshInterval;
let lastMetrics = null;

function startMetricsRefresh() {
    metricsRefreshInterval = setInterval(async function() {
        try {
            const response = await fetch('/admin/metrics');
            if (response.ok) {
                const metrics = await response.json();
                const hasChanged = checkMetricsChanged(metrics);
                updateMetricsDisplay(metrics);
                
                // If metrics changed, refresh the user tables
                if (hasChanged) {
                    console.log('Metrics changed, refreshing user tables...');
                    await refreshUserTables();
                }
                
                lastMetrics = metrics;
            }
        } catch (error) {
            console.warn('Failed to refresh metrics:', error);
        }
    }, 10000); // 10 seconds
}

function checkMetricsChanged(newMetrics) {
    if (!lastMetrics) {
        return false; // First load, don't refresh
    }
    
    return (
        lastMetrics.total_users !== newMetrics.total_users ||
        lastMetrics.not_started !== newMetrics.not_started ||
        lastMetrics.saml_tested !== newMetrics.saml_tested ||
        lastMetrics.oidc_tested !== newMetrics.oidc_tested ||
        lastMetrics.passkey_tested !== newMetrics.passkey_tested ||
        lastMetrics.all_methods_tested !== newMetrics.all_methods_tested
    );
}

async function refreshUserTables() {
    try {
        const response = await fetch('/admin/users-data');
        if (response.ok) {
            const data = await response.json();
            updateUserTables(data.active_users, data.inactive_users);
        }
    } catch (error) {
        console.warn('Failed to refresh user tables:', error);
    }
}

function updateUserTables(activeUsers, inactiveUsers) {
    // Update active users count in header
    const activeUsersHeaders = document.querySelectorAll('h5');
    for (const header of activeUsersHeaders) {
        if (header.textContent.includes('Active Users')) {
            header.textContent = `Active Users (${activeUsers.length} users with >0% completion)`;
            break;
        }
    }
    
    // Update inactive users count in header
    const inactiveUsersHeader = document.querySelector('[data-bs-target="#inactiveUsersCollapse"] span');
    if (inactiveUsersHeader) {
        inactiveUsersHeader.textContent = `Inactive Users (${inactiveUsers.length} users with 0% completion)`;
    }
    
    // For now, just show a subtle notification that data was refreshed
    // Full table rebuild would be complex and potentially disruptive
    showRefreshNotification();
}

function showRefreshNotification() {
    // Create a small, temporary notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-sync-alt me-2"></i>
        User data refreshed
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 150);
        }
    }, 3000);
}

function updateMetricsDisplay(metrics) {
    const metricsElement = document.getElementById('metrics-summary');
    if (metricsElement) {
        // Update total users
        const totalUsersCard = metricsElement.querySelector('.text-primary');
        if (totalUsersCard) {
            totalUsersCard.textContent = metrics.total_users;
        }
        
        // Update not started count
        const notStartedCard = metricsElement.querySelector('.text-warning');
        if (notStartedCard) {
            notStartedCard.textContent = metrics.not_started;
        }
        
        // Update tested counts
        const successCards = metricsElement.querySelectorAll('.text-success');
        if (successCards[0]) successCards[0].textContent = metrics.saml_tested;
        if (successCards[1]) successCards[1].textContent = metrics.oidc_tested;
        if (successCards[2]) successCards[2].textContent = metrics.passkey_tested;
        if (successCards[3]) successCards[3].textContent = metrics.all_methods_tested;
    }
}

// Filtering functionality
let currentFilter = null;

function applyFilter(filterType) {
    currentFilter = filterType;
    
    // Update card appearances
    document.querySelectorAll('.metric-card').forEach(card => {
        card.classList.remove('border-primary', 'bg-light');
        if (card.dataset.filter === filterType) {
            card.classList.add('border-primary', 'bg-light');
        }
    });
    
    // Show filter status
    const filterStatus = document.getElementById('filter-status');
    const filterDescription = document.getElementById('filter-description');
    
    const filterDescriptions = {
        'all': 'All users',
        'not-started': 'Users who haven\'t started testing (0% completion)',
        'saml': 'Users who have completed SAML testing',
        'oidc': 'Users who have completed OIDC testing', 
        'passkey': 'Users who have completed Passkey testing',
        'complete': 'Users who have completed all testing methods'
    };
    
    filterDescription.textContent = filterDescriptions[filterType] || 'Unknown filter';
    filterStatus.style.display = filterType === 'all' ? 'none' : 'block';
    
    // Filter the user tables
    filterUserTables(filterType);
}

function clearFilter() {
    currentFilter = null;
    
    // Remove card highlighting
    document.querySelectorAll('.metric-card').forEach(card => {
        card.classList.remove('border-primary', 'bg-light');
    });
    
    // Hide filter status
    document.getElementById('filter-status').style.display = 'none';
    
    // Show all users
    filterUserTables('all');
}

function filterUserTables(filterType) {
    const activeUsersSection = document.querySelector('.card.mb-4');
    const inactiveUsersSection = document.querySelector('.card:not(.mb-4)');
    
    if (filterType === 'all') {
        // Show all sections
        if (activeUsersSection) activeUsersSection.style.display = 'block';
        if (inactiveUsersSection) inactiveUsersSection.style.display = 'block';
        
        // Show all user rows
        document.querySelectorAll('tbody tr').forEach(row => {
            row.style.display = '';
        });
    } else if (filterType === 'not-started') {
        // Only show inactive users section
        if (activeUsersSection) activeUsersSection.style.display = 'none';
        if (inactiveUsersSection) {
            inactiveUsersSection.style.display = 'block';
            // Expand the collapse if it's closed
            const collapseElement = document.getElementById('inactiveUsersCollapse');
            if (collapseElement && !collapseElement.classList.contains('show')) {
                new bootstrap.Collapse(collapseElement, {show: true});
            }
        }
    } else {
        // Show active users section, filter rows based on criteria
        if (activeUsersSection) activeUsersSection.style.display = 'block';
        if (inactiveUsersSection) inactiveUsersSection.style.display = 'none';
        
        // Filter rows based on the selected criteria
        const activeUserRows = activeUsersSection ? activeUsersSection.querySelectorAll('tbody tr') : [];
        
        activeUserRows.forEach(row => {
            const samlBadge = row.querySelector('td:nth-child(4) .badge');
            const oidcBadge = row.querySelector('td:nth-child(5) .badge');
            const passkeyBadge = row.querySelector('td:nth-child(6) .badge');
            
            const hasSaml = samlBadge && samlBadge.classList.contains('bg-success');
            const hasOidc = oidcBadge && oidcBadge.classList.contains('bg-success');
            const hasPasskey = passkeyBadge && passkeyBadge.classList.contains('bg-success');
            
            let showRow = false;
            
            switch (filterType) {
                case 'saml':
                    showRow = hasSaml;
                    break;
                case 'oidc':
                    showRow = hasOidc;
                    break;
                case 'passkey':
                    showRow = hasPasskey;
                    break;
                case 'complete':
                    showRow = hasSaml && hasOidc && hasPasskey;
                    break;
            }
            
            row.style.display = showRow ? '' : 'none';
        });
    }
}

// Start auto-refresh when page loads
document.addEventListener('DOMContentLoaded', function() {
    startMetricsRefresh();
    
    // Handle metric card clicks
    document.querySelectorAll('.metric-card').forEach(card => {
        card.addEventListener('click', function() {
            applyFilter(this.dataset.filter);
        });
    });
    
    // Handle clear filter button
    document.getElementById('clear-filter').addEventListener('click', clearFilter);
    
    // Handle collapsible chevron rotation
    const collapseButton = document.querySelector('[data-bs-toggle="collapse"]');
    const chevronIcon = document.querySelector('.fa-chevron-down');
    const collapseElement = document.getElementById('inactiveUsersCollapse');
    
    if (collapseElement && chevronIcon) {
        collapseElement.addEventListener('show.bs.collapse', function () {
            chevronIcon.classList.remove('fa-chevron-down');
            chevronIcon.classList.add('fa-chevron-up');
        });
        
        collapseElement.addEventListener('hide.bs.collapse', function () {
            chevronIcon.classList.remove('fa-chevron-up');
            chevronIcon.classList.add('fa-chevron-down');
        });
    }
});

// Clean up interval when page unloads
window.addEventListener('beforeunload', function() {
    if (metricsRefreshInterval) {
        clearInterval(metricsRefreshInterval);
    }
});
async function viewUserLogs(userId) {
    const modal = new bootstrap.Modal(document.getElementById('userLogsModal'));
    const content = document.getElementById('userLogsContent');
    
    // Show loading state
    content.innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading authentication logs...</p>
        </div>
    `;
    
    modal.show();
    
    try {
        const response = await fetch(`/admin/user/${userId}/logs`);
        const logs = await response.json();
        
        if (logs.length === 0) {
            content.innerHTML = '<p class="text-muted text-center">No authentication logs found for this user.</p>';
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr>';
        html += '<th>Date</th><th>Method</th><th>Status</th><th>IP Address</th><th>Details</th>';
        html += '</tr></thead><tbody>';
        
        logs.forEach(log => {
            const date = new Date(log.timestamp).toLocaleString();
            const statusBadge = log.success 
                ? '<span class="badge bg-success">Success</span>'
                : '<span class="badge bg-danger">Failed</span>';
            
            html += `<tr>
                <td><small>${date}</small></td>
                <td><span class="badge bg-primary">${log.auth_method.toUpperCase()}</span></td>
                <td>${statusBadge}</td>
                <td><code>${log.ip_address}</code></td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary" onclick="showLogDetails(${log.id}, ${JSON.stringify(log.transaction_data).replace(/"/g, '&quot;')})">
                        View
                    </button>
                </td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        content.innerHTML = html;
        
    } catch (error) {
        content.innerHTML = '<div class="alert alert-danger">Error loading logs: ' + error.message + '</div>';
    }
}

function showLogDetails(logId, transactionData) {
    const detailsModal = document.createElement('div');
    detailsModal.className = 'modal fade';
    detailsModal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Log Details #${logId}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre class="bg-light p-3 border rounded" style="max-height: 500px; overflow-y: auto;"><code>${JSON.stringify(transactionData, null, 2)}</code></pre>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(detailsModal);
    const modal = new bootstrap.Modal(detailsModal);
    modal.show();
    
    detailsModal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(detailsModal);
    });
}


async function clearTestStatus(userId, userEmail) {
    if (!confirm(`Clear SAML and OIDC test status for "${userEmail}"? This will allow them to test authentication methods again.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/user/${userId}/clear-tests`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert(`Test status cleared successfully: ${data.message}`);
            // Refresh the page to update the user list
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error clearing test status: ' + error.message);
    }
}

async function deleteUser(userId, userEmail) {
    if (!confirm(`Are you sure you want to delete user "${userEmail}"? This action cannot be undone and will delete all associated data including authentication logs.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/user/${userId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert(`User deleted successfully: ${data.message}`);
            // Refresh the page to update the user list
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error deleting user: ' + error.message);
    }
}

async function reconcilePasskeys() {
    if (!confirm('This will check users who have completed SAML or OIDC testing against Authentik and update passkey statuses to match reality. Continue?')) {
        return;
    }
    
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Reconciling...';
    
    try {
        const response = await fetch('/admin/reconcile-passkeys', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            let message = `Reconciliation completed:\n\n`;
            message += `• Total users: ${data.results.total_users}\n`;
            message += `• Eligible users (>20% completion): ${data.results.eligible_users}\n`;
            message += `• Users checked: ${data.results.users_checked}\n`;
            message += `• Users skipped: ${data.results.users_skipped}\n`;
            message += `• Users updated: ${data.results.users_updated}\n`;
            message += `• Errors: ${data.results.errors}`;
            
            if (data.results.changes.length > 0) {
                message += `\n\nChanges made:\n`;
                data.results.changes.forEach(change => {
                    message += `• ${change}\n`;
                });
            }
            
            alert(message);
            
            if (data.results.users_updated > 0) {
                // Refresh the page to show updated status
                window.location.reload();
            }
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error during reconciliation: ' + error.message);
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}
</script>
{% endblock %}