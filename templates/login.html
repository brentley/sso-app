{% extends "base.html" %}

{% block title %}VisiQuate SSO Test App - Login{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="text-center mb-5">
            <div class="mb-4">
                <div class="bg-primary bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                    <i class="fas fa-shield-alt text-white fs-2"></i>
                </div>
                <h1 class="display-5 fw-bold mb-3">VisiQuate SSO Testing Guide</h1>
                <p class="lead text-muted mb-2">Follow these steps to test and validate your <strong>new</strong> single sign-on (SSO) setup</p>
                <div class="alert alert-warning mx-auto mb-4" style="max-width: 700px; margin-top: 60px;">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fs-3"></i>
                        </div>
                        <div class="col">
                            <h5 class="alert-heading mb-2">ðŸš€ New SSO System Migration</h5>
                            <p class="mb-2">VisiQuate is migrating from the old <code>sso.visiquate.com</code> system to a new, more robust authentication platform at <code>id.visiquate.com</code>. This new system provides:</p>
                            <ul class="mb-2 small">
                                <li><strong>Enhanced Security:</strong> Modern authentication protocols and better password policies</li>
                                <li><strong>Unified Access:</strong> Single identity across all VisiQuate applications</li>
                                <li><strong>Improved Reliability:</strong> More stable authentication infrastructure</li>
                            </ul>
                            <p class="mb-0"><strong>Why test now?</strong> By validating both SAML and OIDC authentication methods work correctly with your account, we ensure a seamless transition when we migrate each application. This prevents any risk of being locked out during the switchover process.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card border-primary shadow-sm mx-auto" style="max-width: 650px;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-info-circle text-primary me-3 fs-4"></i>
                        <div class="text-start">
                            <strong class="text-primary">Guided Testing Process</strong>
                            <div class="text-muted small">Complete each step in order to ensure your SSO configuration is working correctly.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- General Instructions Section -->
        <div class="row mt-4 mb-4">
            <div class="col-lg-10 mx-auto">
                <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(147, 51, 234, 0.05) 100%);">
                    <div class="card-body p-4 text-center">
                        <h4 class="text-primary mb-3">
                            <i class="fas fa-route me-2"></i>
                            Testing Overview
                        </h4>
                        <p class="mb-3 text-muted">This process validates that both SAML and OIDC authentication methods work correctly with the new identity provider, ensuring no users will be locked out during the transition.</p>
                        <div class="row g-3 text-start">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="bg-info bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 30px; height: 30px;">
                                        <span class="fw-bold text-white small">1</span>
                                    </div>
                                    <small class="text-muted">Set up password access</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 30px; height: 30px;">
                                        <span class="fw-bold text-white small">2</span>
                                    </div>
                                    <small class="text-muted">Test SAML authentication</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <div class="bg-success bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 30px; height: 30px;">
                                        <span class="fw-bold text-white small">3</span>
                                    </div>
                                    <small class="text-muted">Test OIDC authentication</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% if current_user.is_authenticated %}
                {% set completed_tests = (current_user.saml_tested|int) + (current_user.oidc_tested|int) %}
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {{ (completed_tests / 2 * 100)|round|int }}%">
                        {{ completed_tests }}/2 Tests Complete
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Step 1: Password Setup -->
        <div class="row mt-5">
            <div class="col-lg-10 mx-auto">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-gradient text-white text-center py-3" style="background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);">
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="bg-white bg-opacity-20 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                <span class="fw-bold text-white">1</span>
                            </div>
                            <h3 class="mb-0 text-white">Set Up Your VisiQuate Account Password</h3>
                        </div>
                    </div>
                    <div class="card-body text-center p-4">
                        <h3 class="card-title mb-4">Step 1: Set Up Your VisiQuate Account Password</h3>
                        
                        <div class="bg-light bg-gradient rounded p-4 mb-4">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-lightbulb text-warning me-3 mt-1 fs-5"></i>
                                <div class="text-start">
                                    <h5 class="text-primary mb-3">What this step does:</h5>
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-user-plus text-success me-2 mt-1"></i>
                                                <div>
                                                    <strong class="text-success">New users:</strong>
                                                    <small class="d-block text-muted">Create your initial password for your VisiQuate account. Your account exists, but needs a password.</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-key text-info me-2 mt-1"></i>
                                                <div>
                                                    <strong class="text-info">Existing users:</strong>
                                                    <small class="d-block text-muted">We're using the standard "forgot password" flow from id.visiquate.com. You can use this same process anytime you forget your password for the new system.</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-start border-primary border-4 ps-4 pe-3 py-3 mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-list-ol me-2"></i>Instructions:
                            </h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-primary rounded-circle me-3 mt-1" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">1</span>
                                        <span>Click the "Set/Reset Password" button below</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-primary rounded-circle me-3 mt-1" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">2</span>
                                        <span>Enter your @visiquate.com email address</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-primary rounded-circle me-3 mt-1" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">3</span>
                                        <span>Check your email for a password reset link</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-primary rounded-circle me-3 mt-1" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">4</span>
                                        <span>Follow the link to create your new password</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-success rounded-circle me-3 mt-1" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">5</span>
                                        <span><strong>Return here to continue with the remaining test steps</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mb-4">
                            <strong>Important:</strong> You must complete this step before proceeding to the next part of the test.
                        </div>
                        
                        <div class="d-grid gap-2 col-md-6 mx-auto">
                            <a href="https://id.visiquate.com/if/flow/default-recovery-flow/?next=%2F" 
                               target="_blank" 
                               class="btn btn-primary btn-lg">
                                <i class="fas fa-key me-2"></i>Set/Reset Password
                            </a>
                        </div>
                        
                        <div class="mt-4 p-3 border rounded border-warning">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle text-warning me-2 fs-5"></i>
                                <div>
                                    <strong class="text-warning">Important:</strong>
                                    <span>This link will open in a new tab. After setting your password, return to this page to continue.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visual Arrow Connector -->
        <div class="row mt-3 mb-3">
            <div class="col-lg-10 mx-auto text-center">
                <div class="d-flex align-items-center justify-content-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-arrow-down text-primary fs-1" style="opacity: 0.7;"></i>
                    </div>
                </div>
                <small class="text-muted mt-2 d-block">After completing Step 1, proceed to Steps 2-3 below</small>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-lg-10 mx-auto">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-gradient text-white text-center py-3" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                        <h5 class="mb-0 text-white">
                            <i class="fas fa-shield-check me-2"></i>
                            Authentication Method Testing
                        </h5>
                    </div>
                    <div class="card-body p-0">
                            
                            <!-- SAML Test -->
                            <div class="border-0 p-4" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                                <span class="fw-bold text-white fs-5">2</span>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h5 class="mb-1 text-primary">Test SAML Authentication</h5>
                                                <p class="text-muted mb-0 small">Validate SAML 2.0 authentication flow with id.visiquate.com</p>
                                            </div>
                                            {% if current_user.is_authenticated and current_user.saml_tested %}
                                                <div class="badge bg-success ms-2">
                                                    <i class="fas fa-check me-1"></i>Complete
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <div>
                                                {% if current_user.is_authenticated and current_user.saml_tested %}
                                                    <span class="text-success">
                                                        <i class="fas fa-check-circle me-1"></i>Test completed successfully
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">
                                                        <i class="fas fa-play me-1"></i>Ready to test SAML authentication
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <a href="{{ url_for('saml_login') }}" class="btn {{ 'btn-outline-success' if (current_user.is_authenticated and current_user.saml_tested) else 'btn-primary' }} btn-sm">
                                                {% if current_user.is_authenticated and current_user.saml_tested %}
                                                    <i class="fas fa-redo me-1"></i>Test Again
                                                {% else %}
                                                    <i class="fas fa-rocket me-1"></i>Start Test
                                                {% endif %}
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Visual Separator Between Steps -->
                            <div class="text-center py-4">
                                <div class="d-inline-flex align-items-center px-4 py-2 bg-light rounded-pill">
                                    <i class="fas fa-arrow-down text-primary me-2"></i>
                                    <small class="text-muted fw-medium">Then proceed to Step 3</small>
                                    <i class="fas fa-arrow-down text-primary ms-2"></i>
                                </div>
                            </div>

                            <!-- OIDC Test -->
                            <div class="border-0 p-4" style="background: linear-gradient(135deg, rgba(5, 150, 105, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="bg-success bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                                <span class="fw-bold text-white fs-5">3</span>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h5 class="mb-1 text-success">Test OIDC Authentication</h5>
                                                <p class="text-muted mb-0 small">Validate OpenID Connect flow with id.visiquate.com</p>
                                            </div>
                                            {% if current_user.is_authenticated and current_user.oidc_tested %}
                                                <div class="badge bg-success ms-2">
                                                    <i class="fas fa-check me-1"></i>Complete
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <div>
                                                {% if current_user.is_authenticated and current_user.oidc_tested %}
                                                    <span class="text-success">
                                                        <i class="fas fa-check-circle me-1"></i>Test completed successfully
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">
                                                        <i class="fas fa-play me-1"></i>Ready to test OIDC authentication
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <a href="{{ url_for('oauth_login', provider='authentik') }}" class="btn {{ 'btn-outline-success' if (current_user.is_authenticated and current_user.oidc_tested) else 'btn-success' }} btn-sm">
                                                {% if current_user.is_authenticated and current_user.oidc_tested %}
                                                    <i class="fas fa-redo me-1"></i>Test Again
                                                {% else %}
                                                    <i class="fas fa-rocket me-1"></i>Start Test
                                                {% endif %}
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        
                        {% if current_user.is_authenticated %}
                            {% if current_user.saml_tested and current_user.oidc_tested %}
                                <div class="text-center py-5 px-4" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);">
                                    <div class="bg-success bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                                        <i class="fas fa-trophy text-white fs-1"></i>
                                    </div>
                                    <h4 class="text-success mb-3 fw-bold">ðŸŽ‰ All Tests Complete!</h4>
                                    <p class="text-muted mb-4">Congratulations! You've successfully tested all authentication methods and validated your SSO setup.</p>
                                    <a href="{{ url_for('success') }}" class="btn btn-success btn-lg px-4">
                                        <i class="fas fa-chart-line me-2"></i>View Authentication Summary
                                    </a>
                                </div>
                            {% else %}
                                <div class="text-center py-4 px-4 border-top">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <i class="fas fa-tasks text-primary me-2"></i>
                                        <span class="text-muted">Complete all tests above to validate your SSO setup</span>
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

{% endblock %}