{% extends "base.html" %}

{% block title %}VisiQuate SSO Test App - Login{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="text-center mb-5">
            <div class="mb-4">
                <div class="bg-primary bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                    <i class="fas fa-shield-alt text-white fs-2"></i>
                </div>
                <h1 class="display-5 fw-bold mb-3">VisiQuate SSO Testing Guide</h1>
                <p class="lead text-muted mb-2">Follow these steps to test and validate your <strong>new</strong> single sign-on (SSO) setup</p>
                <div class="alert alert-warning mx-auto mb-4" style="max-width: 700px; margin-top: 60px;">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fs-3"></i>
                        </div>
                        <div class="col">
                            <h5 class="alert-heading mb-2">ðŸš€ We're Upgrading Your Login System</h5>
                            <p class="mb-2">VisiQuate is switching from our old login system (<code>sso.visiquate.com</code>) to a new, better one (<code>id.visiquate.com</code>). The new system gives you:</p>
                            <ul class="mb-2 small">
                                <li><strong>Better Security:</strong> Stronger protection for your account</li>
                                <li><strong>One Login for Everything:</strong> Use the same login for all VisiQuate apps</li>
                                <li><strong>More Reliable:</strong> Fewer login problems and outages</li>
                            </ul>
                            <p class="mb-0"><strong>Why do I need to test this?</strong> We need to make sure your account works properly with the new system before we switch everything over. If we don't test first, you might get locked out of your VisiQuate applications when we make the change. This quick test prevents that from happening.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card border-primary shadow-sm mx-auto" style="max-width: 650px;">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-info-circle text-primary me-3 fs-4"></i>
                        <div class="text-start">
                            <strong class="text-primary">Guided Testing Process</strong>
                            <div class="text-muted small">Complete each step in order to ensure your SSO configuration is working correctly.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- General Instructions Section -->
        <div class="row mt-4 mb-4">
            <div class="col-lg-10 mx-auto">
                <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(147, 51, 234, 0.05) 100%);">
                    <div class="card-body p-4 text-center">
                        <h4 class="text-primary mb-3">
                            <i class="fas fa-route me-2"></i>
                            What You'll Do
                        </h4>
                        <p class="mb-3 text-muted">You'll test three different ways of logging in to make sure they all work with your account. This includes our exciting new passkey system!</p>
                        <div class="row g-3 text-start">
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-info bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 30px; height: 30px;">
                                        <span class="fw-bold text-white small">1</span>
                                    </div>
                                    <small class="text-muted">Create your password</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 30px; height: 30px;">
                                        <span class="fw-bold text-white small">2</span>
                                    </div>
                                    <small class="text-muted">Test SAML login</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-success bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 30px; height: 30px;">
                                        <span class="fw-bold text-white small">3</span>
                                    </div>
                                    <small class="text-muted">Test OIDC login</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-warning bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 30px; height: 30px;">
                                        <span class="fw-bold text-white small">4</span>
                                    </div>
                                    <small class="text-muted">Test passkey login</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% if current_user.is_authenticated %}
                {% set completed_tests = (current_user.saml_tested|int) + (current_user.oidc_tested|int) + (current_user.passkey_tested|int) %}
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {{ (completed_tests / 3 * 100)|round|int }}%">
                        {{ completed_tests }}/3 Tests Complete
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Step 1: Password Setup -->
        <div class="row mt-5">
            <div class="col-lg-10 mx-auto">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-gradient text-white text-center py-3" style="background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);">
                        <div class="d-flex align-items-center justify-content-center">
                            <div class="bg-white bg-opacity-20 rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                <span class="fw-bold text-white">1</span>
                            </div>
                            <h3 class="mb-0 text-white">Create Your Password</h3>
                        </div>
                    </div>
                    <div class="card-body text-center p-4">
                        <h3 class="card-title mb-4">Step 1: Set Up Your VisiQuate Account Password</h3>
                        
                        <div class="bg-light bg-gradient rounded p-4 mb-4">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-lightbulb text-warning me-3 mt-1 fs-5"></i>
                                <div class="text-start">
                                    <h5 class="text-primary mb-3">What's happening here:</h5>
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-user-plus text-success me-2 mt-1"></i>
                                                <div>
                                                    <strong class="text-success">First time?</strong>
                                                    <small class="d-block text-muted">Your account is already set up, but you need to create a password to log in with the new system.</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-key text-info me-2 mt-1"></i>
                                                <div>
                                                    <strong class="text-info">Been here before?</strong>
                                                    <small class="d-block text-muted">This is just the "forgot password" feature. You can use this anytime you need to reset your password.</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-start border-primary border-4 ps-4 pe-3 py-3 mb-4">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-list-ol me-2"></i>Here's what to do:
                            </h5>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-primary rounded-circle me-3 mt-1" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">1</span>
                                        <span>Click the "Set/Reset Password" button below</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-primary rounded-circle me-3 mt-1" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">2</span>
                                        <span>Type your @visiquate.com email address</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-primary rounded-circle me-3 mt-1" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">3</span>
                                        <span>Check your email for a password link</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-primary rounded-circle me-3 mt-1" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">4</span>
                                        <span>Click the link and create your password</span>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex align-items-start">
                                        <span class="badge bg-success rounded-circle me-3 mt-1" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">5</span>
                                        <span><strong>Come back here to finish the test</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mb-4">
                            <strong>Important:</strong> You must complete this step before proceeding to the next part of the test.
                        </div>
                        
                        <div class="d-grid gap-2 col-md-6 mx-auto">
                            <a href="https://id.visiquate.com/if/flow/default-recovery-flow/?next=%2F" 
                               target="_blank" 
                               class="btn btn-primary btn-lg">
                                <i class="fas fa-key me-2"></i>Set/Reset Password
                            </a>
                        </div>
                        
                        <div class="mt-4 p-3 border rounded border-warning">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle text-warning me-2 fs-5"></i>
                                <div>
                                    <strong class="text-warning">Important:</strong>
                                    <span>This link will open in a new tab. After setting your password, return to this page to continue.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visual Arrow Connector -->
        <div class="row mt-3 mb-3">
            <div class="col-lg-10 mx-auto text-center">
                <div class="d-flex align-items-center justify-content-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-arrow-down text-primary fs-1" style="opacity: 0.7;"></i>
                    </div>
                </div>
                <small class="text-muted mt-2 d-block">After completing Step 1, proceed to Steps 2-3 below</small>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-lg-10 mx-auto">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-gradient text-white text-center py-3" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                        <h5 class="mb-0 text-white">
                            <i class="fas fa-shield-check me-2"></i>
                            Authentication Method Testing
                        </h5>
                    </div>
                    <div class="card-body p-0">
                            
                            <!-- SAML Test -->
                            <div class="border-0 p-4" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                                <span class="fw-bold text-white fs-5">2</span>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h5 class="mb-1 text-primary">Test Login Method #1</h5>
                                                <p class="text-muted mb-0 small">Try logging in using the first method (SAML)</p>
                                            </div>
                                            {% if current_user.is_authenticated and current_user.saml_tested %}
                                                <div class="badge bg-success ms-2">
                                                    <i class="fas fa-check me-1"></i>Complete
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <div>
                                                {% if current_user.is_authenticated and current_user.saml_tested %}
                                                    <span class="text-success">
                                                        <i class="fas fa-check-circle me-1"></i>This login method works!
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">
                                                        <i class="fas fa-play me-1"></i>Click to try this login method
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <a href="{{ url_for('saml_login') }}" class="btn {{ 'btn-outline-success' if (current_user.is_authenticated and current_user.saml_tested) else 'btn-primary' }} btn-sm">
                                                {% if current_user.is_authenticated and current_user.saml_tested %}
                                                    <i class="fas fa-redo me-1"></i>Test Again
                                                {% else %}
                                                    <i class="fas fa-rocket me-1"></i>Start Test
                                                {% endif %}
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Visual Separator Between Steps -->
                            <div class="text-center py-4">
                                <div class="d-inline-flex align-items-center px-4 py-2 bg-light rounded-pill">
                                    <i class="fas fa-arrow-down text-primary me-2"></i>
                                    <small class="text-muted fw-medium">Then proceed to Step 3</small>
                                    <i class="fas fa-arrow-down text-primary ms-2"></i>
                                </div>
                            </div>

                            <!-- OIDC Test -->
                            <div class="border-0 p-4" style="background: linear-gradient(135deg, rgba(5, 150, 105, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="bg-success bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                                <span class="fw-bold text-white fs-5">3</span>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h5 class="mb-1 text-success">Test Login Method #2</h5>
                                                <p class="text-muted mb-0 small">Try logging in using the second method (OIDC)</p>
                                            </div>
                                            {% if current_user.is_authenticated and current_user.oidc_tested %}
                                                <div class="badge bg-success ms-2">
                                                    <i class="fas fa-check me-1"></i>Complete
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <div>
                                                {% if current_user.is_authenticated and current_user.oidc_tested %}
                                                    <span class="text-success">
                                                        <i class="fas fa-check-circle me-1"></i>This login method works!
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">
                                                        <i class="fas fa-play me-1"></i>Click to try this login method
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <a href="{{ url_for('oauth_login', provider='authentik') }}" class="btn {{ 'btn-outline-success' if (current_user.is_authenticated and current_user.oidc_tested) else 'btn-success' }} btn-sm">
                                                {% if current_user.is_authenticated and current_user.oidc_tested %}
                                                    <i class="fas fa-redo me-1"></i>Test Again
                                                {% else %}
                                                    <i class="fas fa-rocket me-1"></i>Start Test
                                                {% endif %}
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Visual Separator Between Steps 3 and 4 -->
                            <div class="text-center py-4">
                                <div class="d-inline-flex align-items-center px-4 py-2 bg-light rounded-pill">
                                    <i class="fas fa-arrow-down text-primary me-2"></i>
                                    <small class="text-muted fw-medium">Finally, test the new passkey system</small>
                                    <i class="fas fa-arrow-down text-primary ms-2"></i>
                                </div>
                            </div>

                            <!-- Passkey Test -->
                            <div class="border-0 p-4" style="background: linear-gradient(135deg, rgba(249, 115, 22, 0.05) 0%, rgba(251, 146, 60, 0.05) 100%);">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="bg-warning bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                                <span class="fw-bold text-white fs-5">4</span>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h5 class="mb-1 text-warning">Test Passkey Authentication</h5>
                                                <p class="text-muted mb-0 small">Try the new passwordless login with biometrics or security keys</p>
                                            </div>
                                            {% if current_user.is_authenticated and current_user.passkey_tested %}
                                                <div class="badge bg-success ms-2">
                                                    <i class="fas fa-check me-1"></i>Complete
                                                </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="alert alert-info mb-3">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-key text-primary me-2 mt-1"></i>
                                                <div class="small">
                                                    <strong>What are passkeys?</strong> Passkeys are a new, secure way to log in using your fingerprint, face, or a security key instead of passwords. They're more secure and much easier to use!
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between align-items-center mt-3">
                                            <div>
                                                {% if current_user.is_authenticated and current_user.passkey_tested %}
                                                    <span class="text-success">
                                                        <i class="fas fa-check-circle me-1"></i>Passkey authentication works!
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">
                                                        <i class="fas fa-fingerprint me-1"></i>Click to test passkey login
                                                    </span>
                                                {% endif %}
                                            </div>
                                            {% if current_user.is_authenticated %}
                                                <a href="{{ url_for('passkey_status') }}" class="btn {{ 'btn-outline-success' if current_user.passkey_tested else 'btn-warning' }} btn-sm">
                                                    {% if current_user.passkey_tested %}
                                                        <i class="fas fa-redo me-1"></i>Check Status
                                                    {% else %}
                                                        <i class="fas fa-fingerprint me-1"></i>Check Status
                                                    {% endif %}
                                                </a>
                                            {% else %}
                                                <a href="https://id.visiquate.com/if/flow/default-authenticator-webauthn-setup/" target="_blank" class="btn btn-warning btn-sm">
                                                    <i class="fas fa-fingerprint me-1"></i>Set Up Passkey
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        
                        {% if current_user.is_authenticated %}
                            {% if current_user.saml_tested and current_user.oidc_tested and current_user.passkey_tested %}
                                <div class="text-center py-5 px-4" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);">
                                    <div class="bg-success bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                                        <i class="fas fa-trophy text-white fs-1"></i>
                                    </div>
                                    <h4 class="text-success mb-3 fw-bold">ðŸŽ‰ You're All Set!</h4>
                                    <p class="text-muted mb-4">Amazing! All three login methods work perfectly with your account. You're completely ready for the system upgrade, including the new passkey technology!</p>
                                    <a href="{{ url_for('success') }}" class="btn btn-success btn-lg px-4">
                                        <i class="fas fa-chart-line me-2"></i>View Authentication Summary
                                    </a>
                                </div>
                            {% else %}
                                <div class="text-center py-4 px-4 border-top">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <i class="fas fa-tasks text-primary me-2"></i>
                                        <span class="text-muted">Test all three login methods above to finish</span>
                                    </div>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Clear Cookies Section for Testing -->
<div class="row mt-5">
    <div class="col-lg-8 mx-auto">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center p-4">
                <h5 class="text-muted mb-3">
                    <i class="fas fa-broom me-2"></i>
                    Having Trouble?
                </h5>
                <p class="text-muted mb-3">
                    If the login tests aren't working, you can clear your browser data for this site and try again.
                </p>
                <button onclick="clearSiteCookies()" class="btn btn-outline-secondary">
                    <i class="fas fa-broom me-2"></i>Clear Site Cookies
                </button>
                <div class="mt-2">
                    <small class="text-muted">This will only affect this site (sso-app.visiquate.com), not other websites.</small>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
function clearSiteCookies() {
    if (!confirm('This will clear all cookies and stored data for this site only (sso-app.visiquate.com). Other websites will not be affected. This can help resolve authentication issues. Are you sure?')) {
        return;
    }
    
    // Get all cookies for this domain
    const cookies = document.cookie.split("; ");
    
    // Clear each cookie
    cookies.forEach(cookie => {
        const eqPos = cookie.indexOf("=");
        const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
        // Clear cookie for current path
        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
        // Clear cookie for domain
        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=" + window.location.hostname;
        // Clear cookie for parent domain (in case of subdomain)
        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=." + window.location.hostname;
    });
    
    // Clear localStorage and sessionStorage as well
    localStorage.clear();
    sessionStorage.clear();
    
    // Show success message and reload page
    alert('All cookies and stored data for this site have been cleared. The page will refresh.');
    window.location.reload();
}
</script>
{% endblock %}